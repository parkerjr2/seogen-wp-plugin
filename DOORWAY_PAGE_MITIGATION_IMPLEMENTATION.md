# Doorway Page Risk Mitigation - Implementation Summary

## Overview
This implementation adds intent-based content differentiation to reduce Google doorway-page risk for service+city pages.

## Completed Features

### 1. Intent Classification System ✅
**File:** `wp-plugin/seogen/includes/class-seogen-intent-templates.php`

**6 Intent Groups:**
- `emergency_response` - Urgent service calls
- `repair_service` - Standard repair work (DEFAULT)
- `inspection_diagnostic` - Inspections and diagnostics
- `replacement_installation` - New installations
- `preventative_maintenance` - Routine maintenance
- `compliance_safety` - Safety and compliance checks

**Template Libraries:**
- 5 "Why This Page Exists" variants per intent (80-160 words)
- 3-4 CTA text variants per intent
- Intent-specific Process section structures

**Deterministic Variant Selection:**
- Hash-based: `service_slug + city_slug + intent_group + template_version`
- Same input always produces same output
- Template version constant allows future refreshes

### 2. Service Configuration UI ✅
**File:** `wp-plugin/seogen/includes/class-seogen-admin-extensions.php`

**Changes:**
- Added "Intent Type" dropdown to Services table
- 6 intent options with user-friendly labels
- Migration logic defaults existing services to `repair_service`
- Save handler captures and stores `intent_group` field
- Bulk-add services default to `repair_service`

### 3. "Why This Page Exists" Block ✅
**File:** `wp-plugin/seogen/includes/class-seogen-admin.php`

**Implementation:**
- New block type inserted after hero section
- Only for `service_city` pages with valid intent data
- Uses deterministic template selection
- Replaces `{city}` placeholder with actual city name
- Outputs as paragraph blocks with `seogen-why-exists` class

**Block Order:**
1. Hero (H1 + lead + CTA button)
2. **Why This Page Exists** (NEW - 1-2 paragraphs)
3. Body content (intro, services, etc.)
4. Process section
5. FAQ
6. CTA

### 4. Metadata Flow ✅
**Files:** 
- `class-seogen-admin.php` (preview generation)
- `class-seogen-admin.php` (bulk job creation)
- `class-seogen-admin-import.php` (import coordinator)

**Metadata Passed:**
- `intent_group` - From service configuration
- `service_slug` - For deterministic variant selection
- `city_name` - For {city} placeholder replacement
- `city_slug` - For deterministic variant selection

**Call Sites Updated:**
- Preview generation ✅
- Bulk job creation ✅
- Import coordinator ✅

### 5. Intent-Locked CTA Text ✅
**File:** `wp-plugin/seogen/includes/class-seogen-admin.php`

**Implementation:**
- CTA button text overridden for service_city pages
- Uses `SEOgen_Intent_Templates::get_cta_text()`
- Deterministic selection based on service+city+intent
- Falls back to default for non-service_city pages

**Examples:**
- `emergency_response`: "Get Help Now", "Call for Emergency Service"
- `repair_service`: "Request Repair Service", "Book a Repair Visit"
- `inspection_diagnostic`: "Schedule an Inspection", "Book a Diagnostic Visit"
- `replacement_installation`: "Request an Estimate", "Get a Replacement Quote"
- `preventative_maintenance`: "Schedule Maintenance", "Set Up Maintenance Service"
- `compliance_safety`: "Request a Compliance Check", "Schedule a Safety Inspection"

## Remaining Work

### 6. Intent-Specific Process Section ⏳
**Status:** Requires backend AI integration

**Current Situation:**
- Process section content is generated by the AI backend
- WordPress plugin receives pre-generated Process blocks
- Cannot override Process structure in Gutenberg builder without AI changes

**Required Backend Changes:**
1. Update AI prompt to include `intent_group` parameter
2. Add intent-specific Process instructions to AI prompt
3. Ensure AI generates different Process structures per intent

**Process Structure Examples:**
- **Inspection:** "What We Inspect" → "What You Receive" → "Understanding Results" → "Next Steps"
- **Repair:** "Diagnose Issue" → "Review Options" → "Complete Repair" → "Verify Performance"
- **Emergency:** "Immediate Response" → "Safety & Damage Control" → "Stabilization" → "Follow-Up"

**Recommendation:** Update backend AI generator to accept and use `intent_group` field.

### 7. Validation Gates ⏳
**Status:** Not implemented

**Required Implementation:**
1. Add validation in bulk preview generation
2. Add validation before publish/import
3. Implement noindex fallback for validation failures
4. Block publish for "unsafe truth" violations

**Validation Rules:**
- ✅ Check: `why_this_page_exists` block present
- ✅ Check: CTA text differs across intent groups
- ✅ Check: Process structure differs across intent groups (requires backend)
- ❌ Block: Fake testimonials, addresses, licenses, reviews

**Implementation Location:**
- `prepare_bulk_job_response()` - Preview validation
- `import_service_city_from_result()` - Publish validation
- Add `_seogen_validation_status` post meta
- Set `noindex` via Yoast/RankMath meta if validation fails

### 8. Testing ⏳
**Status:** Not tested

**Test Cases:**
1. Create service with `inspection_diagnostic` intent
2. Generate page for Tulsa, OK
3. Verify:
   - Why block mentions inspection/diagnostic
   - CTA says "Schedule an Inspection" or similar
   - Process structure is inspection-focused (requires backend)
4. Create service with `repair_service` intent
5. Generate page for Tulsa, OK
6. Verify:
   - Why block mentions repair decisions
   - CTA says "Request Repair Service" or similar
   - Process structure is repair-focused (requires backend)
7. Regenerate both pages and verify text stays identical (deterministic)

## Technical Details

### Deterministic Variant Selection
```php
$hash_input = $service_slug . '|' . $city_slug . '|' . $intent_group . '|' . $variant_type . '|' . TEMPLATE_VERSION;
$hash = crc32( $hash_input );
$variant_index = abs($hash) % $variant_count;
```

### Template Version
- Current: `1.0`
- Increment to refresh all variants intentionally
- Ensures pages don't change on regeneration unless desired

### Migration Strategy
- Existing services default to `repair_service`
- No content regeneration required
- New pages automatically use intent system
- Old pages can be regenerated to add "Why" block

## Files Modified

### New Files
- `wp-plugin/seogen/includes/class-seogen-intent-templates.php`

### Modified Files
- `wp-plugin/seogen/includes/class-seogen-admin.php`
- `wp-plugin/seogen/includes/class-seogen-admin-extensions.php`
- `wp-plugin/seogen/includes/class-seogen-admin-import.php`

## Git Commits
1. `7499ec7` - Add intent_group field and template system
2. `2a18094` - Integrate why_this_page_exists block into Gutenberg builder
3. `37934d3` - Pass metadata to build_gutenberg_content_from_blocks
4. `7d5824a` - Pass intent_group through bulk generation pipeline
5. `e8e006f` - Implement intent-locked CTA text variants

## Next Steps Priority

1. **Backend Integration** - Update AI generator to use intent_group for Process sections
2. **Validation Gates** - Implement validation with noindex fallback
3. **Testing** - Test with Tulsa examples (inspection vs repair)
4. **Documentation** - Update user documentation for intent selection

## Benefits

### Doorway-Page Risk Mitigation
- ✅ Clear "why this page exists" explanation
- ✅ Intent-specific CTA text (not generic)
- ✅ Deterministic content (not random)
- ⏳ Intent-specific Process structures (requires backend)

### User Experience
- ✅ Pages match user intent (inspection pages don't say "repair")
- ✅ Consistent content on regeneration
- ✅ Easy intent selection in Services UI
- ✅ No manual content writing required

### Technical Quality
- ✅ Contractor-agnostic (works for any vertical)
- ✅ No hardcoded content
- ✅ Template-based (easy to update)
- ✅ Backward compatible (existing pages unaffected)
